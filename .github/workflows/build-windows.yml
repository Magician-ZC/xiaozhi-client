name: Build Windows

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (如 1.1.9)'
        required: false
        default: ''
  # 推送 tag 时触发
  push:
    tags: ['v*.*.*']

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow
          
          # 确保关键包已安装
          pip install colorlog rich pendulum python-dateutil aiohttp websockets
          pip install pynput pyperclip pypinyin psutil cryptography
          pip install paho-mqtt mutagen beautifulsoup4 brotli requests
          pip install qasync opencv-python-headless numpy
          
          # 验证 colorlog 安装
          python -c "import colorlog; print(f'colorlog version: {colorlog.__version__}')"
          python -c "import colorlog; print(f'colorlog path: {colorlog.__file__}')"

      - name: Convert icon to ICO
        run: |
          python -c "from PIL import Image; img = Image.open('assets/icon.png'); img.save('assets/icon.ico', format='ICO', sizes=[(16,16), (32,32), (48,48), (64,64), (128,128), (256,256)])"
        continue-on-error: true

      - name: Build with PyInstaller
        run: |
          # 使用 --collect-all 确保完整收集模块
          pyinstaller xiaozhi.spec --clean --noconfirm --collect-all colorlog --collect-all rich --collect-all pendulum
          
      - name: Verify build contents
        run: |
          echo "=== Checking dist folder ==="
          dir dist\小智\_internal | findstr colorlog || echo "WARNING: colorlog not found in _internal"
          dir dist\小智\_internal\colorlog* 2>nul || echo "colorlog folder not found"
        shell: cmd
        continue-on-error: true

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(python -c "import json; print(json.load(open('build.json'))['version'])")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create ZIP archive
        run: |
          cd dist
          Compress-Archive -Path "小智" -DestinationPath "xiaozhi-windows-v${{ steps.version.outputs.version }}.zip"
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xiaozhi-windows-v${{ steps.version.outputs.version }}
          path: dist/xiaozhi-windows-v${{ steps.version.outputs.version }}.zip
          retention-days: 30

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/xiaozhi-windows-v${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
